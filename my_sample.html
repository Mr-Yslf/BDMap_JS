<!DOCTYPE html>
<html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
	<style type="text/css">
	body, html{width: 100%;height: 100%;margin:0;font-family:"微软雅黑";}
	#allmap {width: 100%; height:100%; overflow: hidden;}
	#result {width:100%;font-size:12px;}
	dl,dt,dd,ul,li{
		margin:0;
		padding:0;
		list-style:none;
	}
	p{font-size:12px;}
	dt{
		font-size:14px;
		font-family:"微软雅黑";
		font-weight:bold;
		border-bottom:1px dotted #000;
		padding:5px 0 5px 5px;
		margin:5px 0;
	}
	dd{
		padding:5px 0 0 5px;
	}
	li{
		line-height:28px;
	}
	</style>
	<script type="text/javascript" src="http://api.map.baidu.com/api?v=2.0&ak=DUcoOOGEL6vt1ghHWaTSNr9BBykVhUnA"></script>
	<!--加载鼠标绘制工具-->
	<script type="text/javascript" src="http://api.map.baidu.com/library/DrawingManager/1.4/src/DrawingManager_min.js"></script>
	<link rel="stylesheet" href="http://api.map.baidu.com/library/DrawingManager/1.4/src/DrawingManager_min.css" />


	<title>MyMap</title>
</head>
<body>
	<div id="allmap" style="overflow:hidden;zoom:1;position:relative;">	
		<div id="map" style="height:100%;-webkit-transition: all 0.5s ease-in-out;transition: all 0.5s ease-in-out;"></div>
	</div>
	<div id="result">
		<input type="button" onclick="alert(i)" value="i" />
		<input type="button" onclick="alert(overlays.length)" value="个数" />
		<input type="button" onclick="remove_marker()" value="覆盖物-1" />
		<input type="button" onclick="remove_overlay();" value="删除覆盖物" />
		<input type="button" onclick="add_station();" value="添加航点" />
		<input type="button" onclick="stop_add();" value="停止添加" />
		<input type="button" onclick="editable();" value="可拖拽" />
		<input type="button" onclick="diseditable();" value="不可拖拽" />
	</div>
	<script src="baiduTilesInfo.js"></script>
	<script src="qwebchannel.js"></script>
	<script type="text/javascript">
		// 百度地图API功能
		var map = new BMap.Map('allmap',{enableMapClick:false});
		map.setMapType(BMAP_HYBRID_MAP);
		var point = new BMap.Point(118.826497,32.04023);                      //南航明故宫校区
		map.centerAndZoom(point, 16);
		var pointArr=new Array();
		var labelArr=new Array();
		var lineLabel = new Array();
		var trailArr=new Array();
		var line=new Array();
		var p_line;
		var p_point = new BMap.Point;
		var pointmark = new Array();
		var label = new Array();
		var i=0;
		var yaw = 0;
		var LineMesgShow = true;
		var last_point;
		var overlays = [];
		var menu = new BMap.ContextMenu();
		var txtMenuItem = [
		{
			text:'添加航点',
			callback:function(){add_station();}
		},
		{
			text:'编辑航点',
			callback:function(){editable();}
		},
		{
			text:'编辑完成',
			callback:function(){diseditable();}
		},
		{
			text:'隐藏/显示航线标签',
			callback:function(){showlinemesg();}
		},
		{
			text:'删除上一航点',
			callback:function(){remove_marker();}
		}];
		//坐标转换变量
		var piObj = {
		x_PI : 3.14159265358979324 * 3000.0 / 180.0,
		PIs : 3.1415926535897932384626,
		a : 6378245.0,
		ee : 0.00669342162296594323
		}

		var myIcon = new BMap.Icon('./heli.png', new BMap.Size(40, 61), {
                        offset: new BMap.Size(0, 0), // 指定定位位置
						
                        imageOffset: new BMap.Size(0, 0) // 设置图片偏移
						
                    });
	    var mk = new BMap.Marker(point,{icon:myIcon,rotation:0,title: '11111'});//创建标注图标
	    map.addOverlay(mk);//将标注添加到地图中
	 
		map.enableScrollWheelZoom();   //启用滚轮放大缩小，默认禁用
		map.enableContinuousZoom();    //启用地图惯性拖拽，默认禁用
		for(var n=0; n < txtMenuItem.length; n++){
			menu.addItem(new BMap.MenuItem(txtMenuItem[n].text,txtMenuItem[n].callback));
		}
		map.addContextMenu(menu);
	new QWebChannel(qt.webChannelTransport, function(channel) {
        window.bridge = channel.objects.bridge;
    });
	function IPlocate(){
		var myCity = new BMap.LocalCity();
		myCity.get(myFun);
	}
	function myFun(result){
		var cityName = result.name;
		map.setCenter(cityName);
		bridge.local_city(cityName);
	}
	var myCity = new BMap.LocalCity();
	myCity.get(myFun);

	//鼠标单击获取百度坐标---->转换为原始坐标
	map.addEventListener("click", function (e) {
		
		var WGS_Point = BDToWGS(e.point.lng,e.point.lat);
		bridge.getCoordinate(WGS_Point[0], WGS_Point[1]);
      });
	cen_translateCallback = function(data){
		if(data.status === 0){
			map.setCenter(data.points[0]);
         	last_point = data.points[0];
		}
		else{
			alert("else");
		}
	}
	//接收GPS坐标------->转换为百度坐标 并且定位
	function locate(lon,lat) {
		var cen_convert = new BMap.Convertor();
		var cen_point = [];
		cen_point.push(new BMap.Point(lon,lat));
		cen_convert.translate(cen_point, 1, 5, cen_translateCallback)
	}

	function back_home(){
		map.centerAndZoom(new BMap.Point(118.826497,32.04023),17);
	}
	  //删除航点
	function remove_marker(){
		bridge.deletestation();
			i--;
		if(i<1) i=0;
		
		map.removeOverlay(pointmark[i]);
		map.removeOverlay(line[i]); 	
		line.pop();
		pointArr.pop();
		pointmark.pop();	
		p_point = pointArr[pointArr.length-1];
	}
	//添加航点
	function draw_marker(e){
		var p = new BMap.Point(e.point.lng,e.point.lat);
		p_point = new BMap.Point(e.point.lng,e.point.lat);
		//pointmark[i] = new BMap.Marker(p);
		pointmark.push(new BMap.Marker(p));
		map.addOverlay(pointmark[i]);
		label[i] = new BMap.Label(i,{offset:new BMap.Size(20 ,-10)});
		pointmark[i].setLabel(label[i]);
		var WGS_Point = BDToWGS(pointmark[i].getPosition().lng,pointmark[i].getPosition().lat);	//坐标转换 
		bridge.getstation(i,WGS_Point[0].toFixed(7),WGS_Point[1].toFixed(7));
		(function(i){
			pointmark[i].addEventListener('mouseover',function(){
			labelArr[i] = new BMap.Label(WGS_Point[0].toFixed(6)+', '+WGS_Point[1].toFixed(6),
			{offset:new BMap.Size(-30,40)});
			labelArr[i].setStyle({color:"red"});
			pointmark[i].setLabel(labelArr[i]);
			if(i===0){
				map.removeEventListener('click',draw_marker);
			}})				
			pointmark[i].addEventListener('mouseout',function(){
				labelArr[i].setStyle({
						display:"none"
			});		
			if(i===0){
					map.addEventListener('click',draw_marker);					
			}})           
			})(i)  
		//pointArr[i] = p;
		pointArr.push(p);
		if(i>0){
			draw_line(pointArr[i-1],pointArr[i]);
		}
		i++;
		}
	//根据航点连线
	function draw_line(p1,p2){
		line[i] = new BMap.Polyline([
		p1,
		p2
		],{strokeColor:"yellow", strokeWeight:5, strokeOpacity:0.9});
		map.addOverlay(line[i]); 
		(function(i){
					var p1_wgs = BDToWGS(p1.lng,p1.lat);
					var p2_wgs = BDToWGS(p2.lng,p2.lat);
					var pp = new BMap.Point((p1.lng+p2.lng)/2,(p1.lat+p2.lat)/2);
					
					line[i].addEventListener('mouseover',function(){
						if(LineMesgShow == true){
							line[i].setStrokeColor("blue");
							var mesg = "起点："+p1_wgs[0].toFixed(6)+", "+p1_wgs[1].toFixed(6)+"\n"
									+"终点："+p2_wgs[0].toFixed(6)+", "+p2_wgs[1].toFixed(6)+"\n"
									+"长度："+map.getDistance(p1,p2).toFixed(2)+' 米';
							lineLabel[i] = new BMap.InfoWindow(mesg,{width:0,height:0,title:"第"+i+"段航路：\n"});
							map.openInfoWindow(lineLabel[i],pp);
						}
					})

					line[i].addEventListener('mouseout',function(){
						line[i].setStrokeColor("yellow");
						map.closeInfoWindow();
					})
				})(i)	
	}
	//
	function add_infowin(n){
		var pp = new BMap.Point((pointmark[n].getPosition().lng+pointmark[n-1].getPosition().lng)/2,(pointmark[n].getPosition().lat+pointmark[n-1].getPosition().lat)/2);
		var p1_wgs = BDToWGS(pointmark[n-1].getPosition().lng,pointmark[n-1].getPosition().lat);
		var p2_wgs = BDToWGS(pointmark[n].getPosition().lng,pointmark[n].getPosition().lat);
		line[n].addEventListener('mouseover',function(){
			if(LineMesgShow == true){
				line[n].setStrokeColor("blue");
				var mesg = "起点："+p1_wgs[0].toFixed(6)+", "+p1_wgs[1].toFixed(6)+"\n"
							+"终点："+p2_wgs[0].toFixed(6)+", "+p2_wgs[1].toFixed(6)+"\n"
							+"\n长度："+map.getDistance(pointmark[n].getPosition(),pointmark[n-1].getPosition()).toFixed(2)+' 米';
				lineLabel[n] = new BMap.InfoWindow(mesg,{width:300,height:100,title:"第"+n+"段航路：\n"});
				map.openInfoWindow(lineLabel[n],pp);
			}
		})
		line[n].addEventListener('mouseout',function(){
			line[n].setStrokeColor("yellow");
			map.closeInfoWindow();
		})
	}

	//根据GPS坐标绘制轨迹
	translateCallback = function(data){
		if(data.status === 0){
			var polyline = new BMap.Polyline([
				last_point,
				data.points[0]
			], {strokeColor:"blue", strokeWeight:2, strokeOpacity:0.5});   //创建折线
		map.addOverlay(polyline); 
		last_point = data.points[0];       
		}
	}	
	function draw_trail(lon,lat,rot){

		var convertor = new BMap.Convertor();
		var new_point = [];
		new_point.push(new BMap.Point(lon,lat));
		map.removeOverlay(mk);
		mk = new BMap.Marker(point,{icon:myIcon,rotation:rot,title: '11111'});//创建标注图标
		map.addOverlay(mk);//将标注添加到地图中
		convertor.translate(new_point,1,5,translateCallback);	
	}
	function draw_pline(e){
		var t = new BMap.Point(e.point.lng,e.point.lat);
			if(i>0)
			{
				map.removeOverlay( p_line);          //先把之前的折线删除
				p_line = new BMap.Polyline([        //添加新的折线
						p_point,
						t
					],{strokeColor:"pink", strokeWeight:5, strokeOpacity:0.5});
				map.addOverlay(p_line);
			}
	}
	
	//清除覆盖物
	function remove_overlay(){
		map.clearOverlays();   
		stop_add();
		i=0;
		overlays.length = 0 ;
		line.length = 0;
	}
	//添加航点
	function add_station(){
		map.addEventListener('click',draw_marker);
		map.addEventListener('mousemove',draw_pline);
		map.addEventListener('rightclick',function(){
			map.removeEventListener('click',draw_marker);
			map.removeEventListener('mousemove',draw_pline);
			map.removeOverlay(p_line);
		});
	}
	//停止添加
	function stop_add(){
		map.removeEventListener('click',draw_marker);
		map.removeEventListener('mousemove',draw_pline);
		map.removeOverlay(p_line);
	}
	//设置航点可拖拽
	function editable(){
		stop_add();                            //拖拽的时候关闭添加航点
		for(var j=0;j<=pointmark.length;j++)
		{
			pointmark[j].enableDragging();     //所有的点设置可拖拽
				(function(j){
				pointmark[j].addEventListener('dragging',function(){           //拖拽过程中 设置红色的预览航线
				if((j == pointmark.length-1) && (j !=0 ))              //最后一个航点
				{
					map.removeOverlay(line[j]);          //先把之前的折线删除
					line[j] = new BMap.Polyline([        //添加新的折线
						pointmark[j].getPosition(),
						pointmark[j-1].getPosition()
					],{strokeColor:"pink", strokeWeight:5, strokeOpacity:0.5});
					map.addOverlay(line[j]);
				}
					else if(j == 0 )                          //第一个航点
				{
					map.removeOverlay(line[j+1]);           //先把之前的折线删除
					line[j+1] = new BMap.Polyline([         //添加新的折线
						pointmark[j+1].getPosition(),        
						pointmark[j].getPosition()
					],{strokeColor:"pink", strokeWeight:5, strokeOpacity:0.5});
					map.addOverlay(line[j+1]); 	
				}
				else
				{
					map.removeOverlay(line[j+1]);   //先把之前的两条折线删除
					map.removeOverlay(line[j]);
					line[j+1] = new BMap.Polyline([         //添加第一条折线
						pointmark[j+1].getPosition(),        
						pointmark[j].getPosition()
					],{strokeColor:"pink", strokeWeight:5, strokeOpacity:0.5});
					map.addOverlay(line[j+1]); 	
					line[j] = new BMap.Polyline([          //添加第二条折线
						pointmark[j].getPosition(),
						pointmark[j-1].getPosition()
					],{strokeColor:"pink", strokeWeight:5, strokeOpacity:0.5});
					map.addOverlay(line[j]);
				}
				var p_wgs = BDToWGS(pointmark[j].getPosition().lng,pointmark[j].getPosition().lat);
				labelArr[j].setContent(p_wgs[0].toFixed(6)+','+p_wgs[1].toFixed(6)); //实时显示拖拽点的坐标 
			})
			pointmark[j].addEventListener('dragend',function(){         //拖拽结束 生成黄色航线

				if((j == pointmark.length-1) && (j !=0 ))
				{
					map.removeOverlay(line[j]);
						line[j] = new BMap.Polyline([      //添加第二条折线
					pointmark[j].getPosition(),
					pointmark[j-1].getPosition()
					],{strokeColor:"yellow", strokeWeight:5, strokeOpacity:0.9});
					map.addOverlay(line[j]);
					pointArr[j] = pointmark[j].getPosition();
					(function(j){
					add_infowin(j);
				})(j)	
				}
				else if(j == 0)
				{
					map.removeOverlay(line[j+1]);  //先把之前的两条折线删除
					line[j+1] = new BMap.Polyline([     //添加第一条折线
					pointmark[j+1].getPosition(),
					pointmark[j].getPosition()
					],{strokeColor:"yellow", strokeWeight:5, strokeOpacity:0.9});
					map.addOverlay(line[j+1]); 
					(function(j){
					add_infowin(j+1);
				})(j)		
				}
				else
				{
					map.removeOverlay(line[j+1]);  //先把之前的两条折线删除
					map.removeOverlay(line[j]);
					line[j+1] = new BMap.Polyline([     //添加第一条折线
					pointmark[j+1].getPosition(),
					pointmark[j].getPosition()
					],{strokeColor:"yellow", strokeWeight:5, strokeOpacity:0.9});
					map.addOverlay(line[j+1]); 	

					line[j] = new BMap.Polyline([      //添加第二条折线
					pointmark[j].getPosition(),
					pointmark[j-1].getPosition()
					],{strokeColor:"yellow", strokeWeight:5, strokeOpacity:0.9});
					map.addOverlay(line[j]);    

					(function(j){
					add_infowin(j+1);
					add_infowin(j);
				})(j)		          		
				}
				var p_wgs = BDToWGS(pointmark[j].getPosition().lng,pointmark[j].getPosition().lat);
				bridge.getstation(j,p_wgs[0].toFixed(7),p_wgs[1].toFixed(7));  
				})
				})(j)
			}
	}
	//设置航点不可拖拽
	function diseditable(){
		for(var j=0;j<pointmark.length;j++){
			pointmark[j].disableDragging();
		}
	}
	//航线标签是否显示
	function showlinemesg(){
		if(LineMesgShow == true){
			LineMesgShow = false;
			txtMenuItem[3].text = '隐藏航线标签';
		}
		else{
			LineMesgShow = true;
			txtMenuItem[3].text = '显示航线标签';
		}
	}
	function BDToGc(bd_lon, bd_lat) {
	var x_pi = 3.14159265358979324 * 3000.0 / 180.0;
	var x = bd_lon - 0.0065;
	var y = bd_lat - 0.006;
	var z = Math.sqrt(x * x + y * y) - 0.00002 * Math.sin(y * x_pi);
	var theta = Math.atan2(y, x) - 0.000003 * Math.cos(x * x_pi);
	var gg_lng = z * Math.cos(theta);
	var gg_lat = z * Math.sin(theta);
	return [gg_lng, gg_lat];
	}
	function BDToWGS(bd_lng, bd_lat){
		var GCPoint = BDToGc(bd_lng,bd_lat);
		var WGS_Point = gcToWgs(GCPoint[0],GCPoint[1]);
		return [WGS_Point[0],WGS_Point[1]];
	}
	function gcToWgs(lng, lat) {
	var dlat = transformlat(lng - 105.0, lat - 35.0);
	var dlng = transformlng(lng - 105.0, lat - 35.0);
	var radlat = lat / 180.0 * piObj.PIs;
	var magic = Math.sin(radlat);
	magic = 1 - piObj.ee * magic * magic;
	var sqrtmagic = Math.sqrt(magic);
	dlat = (dlat * 180.0) / ((piObj.a * (1 - piObj.ee)) / (magic * sqrtmagic) * piObj.PIs);
	dlng = (dlng * 180.0) / (piObj.a / sqrtmagic * Math.cos(radlat) * piObj.PIs);
	mglat = lat + dlat;
	mglng = lng + dlng;
	return [lng * 2 - mglng, lat * 2 - mglat];
	}
	function transformlat(lng, lat) {
	var ret = -100.0 + 2.0 * lng + 3.0 * lat + 0.2 * lat * lat + 0.1 * lng * lat + 0.2 * Math.sqrt(Math.abs(lng));
	ret += (20.0 * Math.sin(6.0 * lng * piObj.PIs) + 20.0 * Math.sin(2.0 * lng * piObj.PIs)) * 2.0 / 3.0;
	ret += (20.0 * Math.sin(lat * piObj.PIs) + 40.0 * Math.sin(lat / 3.0 * piObj.PIs)) * 2.0 / 3.0;
	ret += (160.0 * Math.sin(lat / 12.0 * piObj.PIs) + 320 * Math.sin(lat * piObj.PIs / 30.0)) * 2.0 / 3.0;
	return ret
	}
	function transformlng(lng, lat) {
		var ret = 300.0 + lng + 2.0 * lat + 0.1 * lng * lng + 0.1 * lng * lat + 0.1 * Math.sqrt(Math.abs(lng));
		ret += (20.0 * Math.sin(6.0 * lng * piObj.PIs) + 20.0 * Math.sin(2.0 * lng * piObj.PIs)) * 2.0 / 3.0;
		ret += (20.0 * Math.sin(lng * piObj.PIs) + 40.0 * Math.sin(lng / 3.0 * piObj.PIs)) * 2.0 / 3.0;
		ret += (150.0 * Math.sin(lng / 12.0 * piObj.PIs) + 300.0 * Math.sin(lng / 30.0 * piObj.PIs)) * 2.0 / 3.0;
		return ret
	}
	</script>
</body>
</html>
